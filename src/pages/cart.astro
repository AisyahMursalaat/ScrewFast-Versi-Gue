---
// src/pages/cart.astro (FINAL: MURNI LOCALSTORAGE & AMAN SSR, REVIEW ONLY)
import MainLayout from "@/layouts/MainLayout.astro";
// Hapus import lama dan variabel fetch API yang tidak perlu di frontmatter

// Inisialisasi variabel di sini agar tidak crash SSR
const cartData = { items: [], totalAmount: 0 };
const formattedTotal = '0'; 
// Hapus semua fetch API dan kalkulasi di frontmatter

---

<MainLayout title="Keranjang Belanja">
  <div class="mx-auto max-w-[85rem] px-4 py-10 sm:px-6 lg:px-8">
    
    <h1 class="text-3xl font-bold mb-8 text-gray-800 dark:text-white border-b pb-4">
      Keranjang Sewa Anda
    </h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      <div class="lg:col-span-2 bg-white dark:bg-neutral-800 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-neutral-700">
        <div id="cart-items" class="space-y-6">
          <p class="text-center text-gray-500 py-10">Sedang memuat keranjang...</p>
        </div>

        <button id="clear-cart" class="mt-6 text-sm text-red-500 hover:text-red-700 underline hidden">
          Kosongkan Keranjang
        </button>
      </div>

      <div class="bg-gray-50 dark:bg-neutral-900 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-neutral-700 h-fit">
        <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">Ringkasan Tagihan</h3>
        
        <div class="flex justify-between mb-2 text-gray-600 dark:text-gray-300">
          <span>Total Unit Sewa</span>
          <span id="total-units">0</span>
        </div>
        
        <div class="border-t my-4 border-gray-300 dark:border-neutral-700"></div>

        <div class="flex justify-between mb-6 text-xl font-bold text-orange-600">
          <span>TOTAL TAGIHAN PENUH</span>
          <span id="total-full-tagihan">Rp 0</span>
        </div>

        <button id="btn-checkout" class="w-full bg-orange-600 text-white py-3 rounded-lg font-bold hover:bg-orange-700 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
          Lanjut Checkout
        </button>

        <a href="/products" class="block text-center mt-4 text-sm text-gray-500 hover:underline">
          + Tambah Sewa Alat Lain
        </a>
      </div>

    </div>
  </div>
</MainLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const cartItemsContainer = document.getElementById('cart-items');
    const totalUnitsEl = document.getElementById('total-units'); 
    const btnCheckout = document.getElementById('btn-checkout');
    const btnClear = document.getElementById('clear-cart');
    const totalFullTagihanEl = document.getElementById('total-full-tagihan');
    
    // Helper untuk format Rupiah
    const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0 }).format(number);

    // Helper untuk menghitung tanggal selesai (asumsi duration_days adalah hari)
    function calculateEndDate(startDate, durationDays) {
        if (!startDate || durationDays < 1) return 'Tanggal Selesai Invalid';
        const date = new Date(startDate);
        // Tambahkan durasi hari (asumsi 1 hari = 24 jam)
        date.setDate(date.getDate() + durationDays); 
        return date.toISOString().split('T')[0];
    }

    // Ambil data Cart dari LocalStorage
    let cart = JSON.parse(localStorage.getItem('cart')) || [];


    function renderCart() {
      if (!cartItemsContainer || !totalFullTagihanEl) return; 

      if (cart.length === 0) {
        cartItemsContainer.innerHTML = `<div class="text-center py-10"><p class="text-gray-500 text-lg mb-4">Keranjang Anda kosong.</p><a href="/products" class="px-4 py-2 bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition">Cari Alat Berat</a></div>`;
        totalUnitsEl.innerText = 0;
        totalFullTagihanEl.innerText = 'Rp 0'; 
        btnCheckout.disabled = true;
        if(btnClear) btnClear.classList.add('hidden');
        return;
      }

      btnCheckout.disabled = false;
      if(btnClear) btnClear.classList.remove('hidden');

      let html = '';
      let totalUnits = 0;
      let totalFullTagihan = 0; 
      
      // Hitung dan Render Item
      cart.forEach((item, index) => {
        const quantity = parseInt(item.kuantitas) || 1; 
        const duration = parseInt(item.duration_days) || 1;
        // PERBAIKAN: Gunakan total_rental_fee yang sudah dihitung di modal/detail page
        const itemRentalFee = parseFloat(item.total_rental_fee) || 0; 
        const deliveryFee = parseFloat(item.delivery_fee) || 0;
        
        // Hitung Full Total (Sewa + Logistik)
        const itemFullTotal = itemRentalFee + deliveryFee; 
        
        // Update Cart Object
        item.total_rental_fee = itemRentalFee;
        item.duration_days = duration;
        
        // Hitung total keranjang
        totalUnits += quantity;
        totalFullTagihan += itemFullTotal; 
        
        const endDate = calculateEndDate(item.start_date, duration);

        html += `
          <div class="flex flex-col sm:flex-row gap-4 items-start border-b pb-6 last:border-0 border-gray-100 dark:border-neutral-700">
            <img src="${item.image || 'https://placehold.co/600x400?text=No+Image'}" class="w-24 h-24 object-cover rounded-lg bg-gray-100 border" />
            
            <div class="flex-1 w-full">
              <h4 class="font-bold text-lg text-gray-800 dark:text-white">${item.name} (${quantity} Unit)</h4>
              <p class="text-sm text-gray-500 mb-2">Harga Harian: Rp ${formatRupiah(item.price_per_day)} | Logistik: Rp ${formatRupiah(deliveryFee)}</p>
              
                <div class="flex flex-col sm:flex-row gap-4 mb-3">
                    <div class="w-full sm:w-1/2">
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Durasi Sewa</label>
                        {/* HILANGKAN INPUT EDIT, GANTI DENGAN TAMPILAN STATIS */}
                        <p class="mt-1 font-semibold">${item.duration_text || duration + ' Hari'}</p> 
                    </div>
                    <div class="w-full sm:w-1/2">
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Mulai Sewa</label>
                        {/* HILANGKAN INPUT EDIT, GANTI DENGAN TAMPILAN STATIS */}
                        <p class="mt-1 font-semibold">${item.start_date || 'Belum dipilih'}</p>
                    </div>
                </div>

                <p class="text-sm text-gray-500 mb-2">Selesai: ${endDate}</p>
              
              <div class="flex justify-between mt-2">
                <p class="font-bold text-gray-800 dark:text-white">TOTAL SEWA ITEM:</p>
                <p class="font-bold text-gray-800 dark:text-white text-lg">Rp ${formatRupiah(itemFullTotal)}</p>
              </div>
              
              <button onclick="hapusItem(${index})" class="text-red-500 text-xs hover:underline mt-2">Hapus Item Sewa</button>
            </div>
          </div>
        `;
      });

      cartItemsContainer.innerHTML = html;
      totalUnitsEl.innerText = totalUnits;
      totalFullTagihanEl.innerText = 'Rp ' + formatRupiah(totalFullTagihan); 
      
      // Simpan kembali ke localStorage setelah render dan kalkulasi
      localStorage.setItem('cart', JSON.stringify(cart));
    }
    
    // --- FUNGSI MANAJEMEN CART CLIENT-SIDE ---

    function saveAndRender() {
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
      window.dispatchEvent(new Event('cartUpdated')); 
    }

    // Hapus Item
    window.hapusItem = (index) => {
        if(confirm("Hapus item sewa ini?")) {
            cart.splice(index, 1);
            saveAndRender();
        }
    }

    // Tombol Checkout
    if(btnCheckout) {
        btnCheckout.addEventListener('click', () => {
          const userId = localStorage.getItem('userId');
          if (!userId) {
            alert("Silakan Login dulu untuk melanjutkan!");
            window.location.href = '/login';
          } else {
            // Redirect ke halaman checkout
            window.location.href = '/checkout';
          }
        });
    }

    // Tombol Kosongkan
    if(btnClear) {
      btnClear.addEventListener('click', () => {
        if(confirm("Yakin mau mengosongkan semua?")) {
          cart = [];
          saveAndRender();
        }
      });
    }

    // Panggil render awal
    renderCart();
  });
</script>