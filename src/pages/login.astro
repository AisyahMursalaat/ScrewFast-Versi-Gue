---
import MainLayout from "@/layouts/MainLayout.astro";
---

<MainLayout title="Login Masuk">
  <div class="flex min-h-screen items-center justify-center bg-gray-100 py-12 px-4 sm:px-6 lg:px-8 dark:bg-neutral-900">
    <div class="w-full max-w-md space-y-8 rounded-xl bg-white p-10 shadow-lg dark:bg-neutral-800">
      
      <div class="text-center">
        <h2 class="text-3xl font-extrabold text-gray-800 dark:text-white">RentHeavyPro Login</h2>
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Masuk untuk akses Dashboard</p>
      </div>

      <form id="loginForm" class="mt-8 space-y-6">
        <div class="-space-y-px rounded-md shadow-sm">
          <div>
            <label for="username" class="sr-only">Username</label>
            <input id="username" type="text" required class="relative block w-full rounded-t-md border border-gray-300 px-3 py-2 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-orange-500 focus:outline-none focus:ring-orange-500 sm:text-sm" placeholder="Username">
          </div>
          <div>
            <label for="password" class="sr-only">Password</label>
            <input id="password" type="password" required class="relative block w-full rounded-b-md border border-gray-300 px-3 py-2 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-orange-500 focus:outline-none focus:ring-orange-500 sm:text-sm" placeholder="Password">
          </div>
        </div>

        <button type="submit" id="btnLogin" class="w-full bg-orange-600 py-2 px-4 text-sm font-medium text-white rounded-md hover:bg-orange-700">Masuk</button>
        <p id="errorMsg" class="hidden text-center text-sm text-red-500 font-bold mt-2"></p>
      </form>
      
      <div class="mt-6 border-t pt-4 text-center text-xs text-gray-400">
        <p>Admin: <b>admin</b> / <b>123</b> | User: <b>user</b> / <b>123</b></p>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';
    const form = document.getElementById('loginForm');
    const btnLogin = document.getElementById('btnLogin');
    const errorMsg = document.getElementById('errorMsg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      btnLogin.innerText = "Mengecek...";
      btnLogin.disabled = true;
      errorMsg.classList.add('hidden');

      const user = document.getElementById('username').value;
      const pass = document.getElementById('password').value;

      try {
          const res = await fetch(`${API_URL}/login`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username: user, password: pass })
          });

          const result = await res.json();

          if (result.success) {
              // SIMPAN DATA USER DARI DATABASE KE BROWSER
              localStorage.setItem('isLoggedIn', 'true');
              localStorage.setItem('userRole', result.data.role); 
              localStorage.setItem('username', result.data.full_name || result.data.username);
              localStorage.setItem('userId', result.data.id); // <--- INI PENTING!

              alert(`Selamat Datang, ${result.data.full_name}!`);

              if (result.data.role === 'admin') {
                  window.location.href = '/admin/dashboard';
              } else {
                  window.location.href = '/dashboard';
              }
          } else {
              throw new Error(result.message);
          }
      } catch (err) {
          errorMsg.innerText = err.message || "Gagal konek ke server.";
          errorMsg.classList.remove('hidden');
          btnLogin.innerText = "Masuk";
          btnLogin.disabled = false;
      }
    });
  </script>
</MainLayout>