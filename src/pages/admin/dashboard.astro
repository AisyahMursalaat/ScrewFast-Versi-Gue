---
// admin/dashboard.astro
import MainLayout from "@/layouts/MainLayout.astro";

const pageTitle = "Panel Administrasi | RentHeavyPro";
---

<MainLayout title={pageTitle}>
    <div class="mx-auto max-w-[95rem] px-4 py-10 sm:px-6 lg:px-8">
        
        <div class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-200 dark:border-neutral-700 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-800 dark:text-white">Panel Administrasi</h1>
                <p class="text-gray-500 text-sm mt-1">Kelola **Semua Pesanan**, Verifikasi Pembayaran, dan Status Unit.</p>
            </div>
            <div class="flex gap-3">
                <a href="/admin/inventory" class="bg-blue-100 text-blue-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-200 transition">‚öôÔ∏è Kelola Unit (Inventaris)</a>
                <button id="logoutAdminBtn" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-200 transition">Logout Admin</button>
            </div>
        </div>

        <div class="bg-white border border-gray-200 rounded-xl shadow-lg dark:bg-neutral-900 dark:border-neutral-700">
            
            <nav class="flex space-x-2 p-4 border-b border-gray-200 dark:border-neutral-700" role="tablist">
                <button type="button" class="tab-button inline-flex items-center gap-x-2 py-2 px-3 text-sm font-medium rounded-lg text-gray-800 hover:text-blue-600 dark:text-gray-200 dark:hover:text-blue-500 active" data-tab="order_management">
                    üìã Kelola Pesanan (Aksi)
                </button>
                <button type="button" class="tab-button inline-flex items-center gap-x-2 py-2 px-3 text-sm font-medium rounded-lg text-gray-800 hover:text-blue-600 dark:text-gray-200 dark:hover:text-blue-500" data-tab="inventory_list">
                    üì¶ Daftar Unit Inventaris
                </button>
                <button type="button" class="tab-button inline-flex items-center gap-x-2 py-2 px-3 text-sm font-medium rounded-lg text-gray-800 hover:text-blue-600 dark:text-gray-200 dark:hover:text-blue-500" data-tab="gps">
                    üì° GPS Tracking (Simulasi)
                </button>
            </nav>

            <div class="p-6">
                
                <div id="tab-order_management" class="tab-content">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
                        <h3 class="font-bold text-gray-700 dark:text-gray-200">Daftar Semua Pesanan</h3>
                        
                        <div class="flex items-center gap-3">
                            <label for="actionFilter" class="text-sm font-medium text-gray-600">Filter Aksi:</label>
                            <select id="actionFilter" onchange="filterOrdersDisplay(this.value)" class="py-2 px-3 pr-9 block border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-neutral-900 dark:border-neutral-700 dark:text-gray-400">
                                <option value="verification">Hanya Verifikasi Baru</option>
                                <option value="extension">Hanya Permintaan Perpanjangan</option>
                                <option value="active">Hanya Unit Aktif/Siap Selesai Sewa</option>
                                <option value="all">Semua Status (Lengkap)</option>
                                <option value="history">Riwayat (Selesai/Ditolak)</option>
                            </select>
                            <button onclick="loadOrdersByStatus('all_data')" class="text-xs text-blue-600 hover:underline flex items-center gap-1">
                                üîÑ Muat Ulang
                            </button>
                        </div>
                    </div>
                    <div id="allOrderList" class="space-y-4 min-h-[300px]">
                        <p class="text-center text-gray-500 py-10 animate-pulse">Sedang memuat data...</p>
                    </div>
                     <div id="historyList" class="space-y-4 min-h-[300px] hidden">
                        <p class="text-center text-gray-500 py-10">Memuat riwayat...</p>
                    </div>
                </div>
                
                <div id="tab-inventory_list" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-700 dark:text-gray-200">Daftar Inventaris Unit (CRUD Products)</h3>
                        <button onclick="openAddUnitModal()" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-800 transition">‚ûï Tambah Unit Baru</button>
                    </div>
                    
                    <div id="unitFormArea" class="border p-4 rounded-lg bg-gray-50 mb-4 hidden">
                        <h4 class="font-bold text-lg mb-4">Tambah Unit Baru</h4>
                        <form id="productForm" onsubmit="handleProductSubmit(event)">
                            <input type="hidden" id="productId" value="">
                            <label class="block text-sm font-medium mb-1">Nama Unit:</label>
                            <input type="text" id="unitName" required class="w-full border p-2 rounded mb-3">
                            
                            <label class="block text-sm font-medium mb-1">Harga Harian:</label>
                            <input type="number" id="unitPrice" required min="1000" class="w-full border p-2 rounded mb-3">
                            
                            <label class="block text-sm font-medium mb-1">Kategori:</label>
                            <select id="unitCategory" required class="w-full border p-2 rounded mb-4">
                                <option value="Heavy">Heavy</option>
                                <option value="Light">Light</option>
                            </select>

                            <button type="submit" id="btnSubmitProduct" class="bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700">Simpan Unit</button>
                            <button type="button" onclick="closeProductForm()" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded ml-2 hover:bg-gray-400">Batal</button>
                            <p id="productErrorMsg" class="text-red-500 text-sm mt-2 hidden"></p>
                        </form>
                    </div>

                    <div id="inventoryList" class="space-y-4 min-h-[300px]">
                        <p class="text-center text-gray-500 py-10">Memuat daftar inventaris...</p>
                    </div>
                </div>

                <div id="tab-gps" class="tab-content hidden">
                    <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-4">Simulasi Lokasi Unit</h3>
                    <div class="bg-gray-100 dark:bg-neutral-800 p-8 rounded-lg min-h-[300px] flex items-center justify-center flex-col">
                        <p class="text-gray-500 font-bold text-lg">üì° PETA AKTIF (Simulasi)</p>
                        <p class="text-gray-500 mt-2 text-sm">Fitur ini akan menampilkan lokasi real-time unit yang statusnya 'active' di sini.</p>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <div id="verifyModal" class="fixed inset-0 z-[999] hidden bg-black/80 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-neutral-900 w-full max-w-lg rounded-2xl shadow-2xl">
            <div class="p-5 bg-gray-900 rounded-t-2xl flex justify-between items-center">
                <h3 class="font-bold text-xl text-white">‚úÖ Verifikasi Pesanan / Perpanjangan</h3>
                <button onclick="closeVerifyModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-sm text-gray-700">Order ID: <b id="verifyOrderId">#TRX-000</b></p>
                <p class="text-sm text-gray-700">Pelanggan: <b id="verifyCustomerName">-</b></p>
                <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg hidden" id="extensionWarningBlock">
                    <p class="text-xs font-bold text-blue-900 mb-1">DETAIL PERPANJANGAN:</p>
                    <p class="text-sm text-blue-700">Durasi Tambahan: <b id="extDurationDisplay">-</b></p>
                    <p class="text-sm text-red-700 font-bold">Biaya Tambahan: <b id="extFeeDisplay">-</b></p>
                </div>
                
                <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-xs font-bold text-red-700 mb-2">DOKUMEN:</p>
                    <a id="verifyDocumentLink" href="#" target="_blank" class="text-sm text-blue-600 font-bold hover:underline">
                        Lihat Dokumen Pelanggan ‚ÜóÔ∏è
                    </a>
                </div>

                <p class="text-base font-bold mt-4">Pilih Aksi:</p>
                
                <div class="flex gap-4">
                    <button id="btnApprove" onclick="submitVerification('approve')" 
                            class="flex-1 bg-gray-900 text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition">
                        ‚úÖ Setujui & Ubah Status ke READY
                    </button>
                    <button id="btnReject" onclick="submitVerification('reject')" 
                            class="flex-1 bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition">
                        ‚ùå Tolak
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="adminInvoiceModal" class="fixed inset-0 z-[999] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white dark:bg-neutral-900 w-full max-w-2xl rounded-2xl shadow-2xl my-8">
            <div class="p-5 border-b border-gray-200 dark:border-neutral-700 flex justify-between items-center bg-gray-900 rounded-t-2xl">
                <h3 class="font-bold text-xl text-white">üìÑ Invoice Pesanan (Admin View)</h3>
                <button onclick="closeAdminInvoiceModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>

            <div id="adminInvoiceContent" class="p-8 space-y-6">
                </div>

            <div class="p-5 border-t bg-gray-50 flex gap-3">
                <button onclick="closeAdminInvoiceModal()" class="flex-1 bg-gray-200 text-gray-800 font-bold py-2.5 rounded-lg hover:bg-gray-300 transition">
                    Tutup
                </button>
                <button onclick="downloadAdminInvoice()" class="flex-1 bg-gray-900 text-white font-bold py-2.5 rounded-lg hover:bg-gray-800 transition shadow-md">
                    üì• Download PDF
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        const API_URL = 'http://localhost:5000/api'; 
        const UPLOAD_URL = 'http://localhost:5000/uploads';
        
        const adminId = localStorage.getItem('adminId');
        let rawAllOrdersData = []; 
        let rawAllProductsData = [];

        // Otentikasi
        if (!adminId || localStorage.getItem('isAdminLoggedIn') !== 'true') {
            window.location.href = '/login'; 
        } else {
            loadOrdersByStatus('all_data'); 
            setupTabs();
        }

        let currentVerificationOrder = null;
        let currentAdminInvoiceOrder = null;
        
        // --- LOGIKA UTAMA LOADING DATA DARI API ---
        async function loadOrdersByStatus(action) {
            const orderListContainer = document.getElementById('allOrderList');
            
            if (action === 'all_data') {
                orderListContainer.innerHTML = '<p class="text-center text-gray-500 py-10 animate-pulse">Memuat data pesanan...</p>';
                
                try {
                    const res = await fetch(`${API_URL}/orders`); 
                    if (!res.ok) {
                        throw new Error('Gagal memuat data dari API /orders.');
                    }
                    rawAllOrdersData = await res.json();
                    
                    filterOrdersDisplay(document.getElementById('actionFilter').value); 

                } catch (error) {
                    console.error('Gagal memuat pesanan Admin:', error);
                    orderListContainer.innerHTML = '<p class="text-center text-red-500 py-10">‚ùå Gagal memuat data. Cek koneksi server atau database.</p>';
                } 
            } else {
                 filterOrdersDisplay(document.getElementById('actionFilter').value);
            }
        }

        // --- LOGIKA FILTER DROPDOWN DI TAB 1 ---
        window.filterOrdersDisplay = (filterType) => {
            let filteredList = [];
            let targetElement = document.getElementById('allOrderList');
            let historyElement = document.getElementById('historyList');

            // Kontrol tampilan berdasarkan filter
            if (filterType === 'history') {
                 targetElement = historyElement;
                 document.getElementById('allOrderList').classList.add('hidden');
                 historyElement.classList.remove('hidden');
            } else {
                 targetElement = document.getElementById('allOrderList');
                 targetElement.classList.remove('hidden');
                 if (historyElement) historyElement.classList.add('hidden');
            }


            switch (filterType) {
                case 'verification':
                    // Pesanan Baru yang butuh Verifikasi awal
                    filteredList = rawAllOrdersData.filter(o => o.status === 'PAID_VERIFY' || o.status === 'pending_verification');
                    break;
                case 'extension':
                    // Hanya Permintaan Perpanjangan
                    filteredList = rawAllOrdersData.filter(o => o.status === 'EXTENDED');
                    break;
                case 'active':
                    // Unit yang sedang Aktif (Siap diproses Selesai Sewa)
                    filteredList = rawAllOrdersData.filter(o => o.status === 'READY' || o.status === 'active');
                    break;
                case 'history':
                    // Riwayat (Completed / Rejected)
                    filteredList = rawAllOrdersData.filter(o => o.status === 'COMPLETED' || o.status === 'rejected');
                    break;
                case 'all':
                default:
                    // Semua status
                    filteredList = rawAllOrdersData;
                    break;
            }
            renderOrderList(filteredList, targetElement);
        }

        // --- LOGIKA PEMUATAN DATA INVENTARIS (TAB 2) ---
        async function loadInventoryData() {
            const inventoryElement = document.getElementById('inventoryList');
            inventoryElement.innerHTML = '<p class="text-center text-gray-500 py-10 animate-pulse">Memuat data inventaris...</p>';
            document.getElementById('unitFormArea').classList.add('hidden'); 

            try {
                const res = await fetch(`${API_URL}/products`);
                if (!res.ok) {
                    throw new Error('Gagal memuat data dari API /products.');
                }
                const products = await res.json();

                if (products.length === 0) {
                    inventoryElement.innerHTML = '<p class="text-center py-10 text-gray-500">Inventaris kosong. Tambahkan unit baru.</p>';
                    return;
                }
                
                // Simpan data produk mentah (diperlukan untuk fungsi edit)
                rawAllProductsData = products;
                
                // Render List Produk
                inventoryElement.innerHTML = products.map(p => `
                    <div class="border border-gray-200 rounded-lg p-4 flex justify-between items-center dark:bg-neutral-800">
                        <div>
                            <h4 class="font-bold text-lg text-gray-800 dark:text-white">${p.name}</h4>
                            <p class="text-sm text-gray-600">Kategori: ${p.category || 'N/A'} | Harga Harian: Rp ${parseInt(p.price).toLocaleString('id-ID')}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openEditUnitForm('${p.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">Edit</button>
                            <button onclick="deleteProduct('${p.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Hapus</button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                 inventoryElement.innerHTML = '<p class="text-center text-red-500 py-10">‚ùå Gagal memuat data inventaris.</p>';
            }
        }
        
        // --- FUNGSI RENDERING DAFTAR PESANAN (TIDAK BERUBAH) ---
        function renderOrderList(data, targetElement) {
            if (data.length === 0) {
                targetElement.innerHTML = '<p class="text-center py-10 text-gray-500">Tidak ada pesanan di status ini.</p>';
                return;
            }

            targetElement.innerHTML = data.map(o => {
                let statusBadge = "";
                let statusClass = "";
                let actionButton = "";
                let buttonColor = "bg-gray-900 hover:bg-gray-800";
                
                const currentTotalFee = parseFloat(o.total_rental_fee) || 0;
                
                const customerNameSafe = o.customer_name ? o.customer_name.replace(/'/g, "\\'") : 'N/A'; 
                const documentPathSafe = o.ktp_sim_image || '';

                let modalData = `data-order-id='${o.order_id}' data-customer-name='${customerNameSafe}' data-document-path='${documentPathSafe}'`;

                // Logika Penentuan Aksi dan Status
                if(o.status === 'pending_verification' || o.status === 'PAID_VERIFY') {
                    statusBadge = "‚è≥ Verifikasi Pembayaran/Dokumen";
                    statusClass = "bg-yellow-100 text-yellow-800 border-yellow-200";
                    actionButton = `<button onclick="openVerifyModal(event)" ${modalData} class="${buttonColor} text-white px-4 py-2 rounded-lg text-sm font-bold transition">
                                        ‚úÖ Verifikasi
                                    </button>`;
                } else if (o.status === 'EXTENDED') {
                    statusBadge = "üîÑ PERPANJANGAN MENUNGGU";
                    statusClass = "bg-blue-100 text-blue-800 border-blue-200";
                    
                    modalData += ` data-is-extension='true' data-extension-duration='${o.duration}'`;
                    modalData += ` data-extension-fee='${currentTotalFee}'`; 

                    actionButton = `<button onclick="openVerifyModal(event)" ${modalData} class="${buttonColor} text-white px-4 py-2 rounded-lg text-sm font-bold transition">
                                        ‚û°Ô∏è Cek Perpanjangan
                                    </button>`;
                } else if (o.status === 'active' || o.status === 'READY') {
                    // Status Aktif / Siap Selesai Sewa
                    statusBadge = o.status === 'active' ? "üü¢ SEDANG BERJALAN" : "‚úÖ SIAP KIRIM";
                    statusClass = "bg-green-100 text-green-800 border-green-200";
                    actionButton = `<button onclick="updateOrderStatus('${o.order_id}', 'COMPLETED')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition">
                                        ‚úÖ Selesai Sewa
                                    </button>`;
                } else if (o.status === 'rejected' || o.status === 'COMPLETED') {
                    // Status Riwayat
                    statusBadge = o.status === 'rejected' ? "‚ùå Ditolak Admin" : "‚úîÔ∏è Selesai";
                    statusClass = o.status === 'rejected' ? "bg-red-100 text-red-800 border-red-200" : "bg-gray-100 text-gray-600 border-gray-200";
                    actionButton = '<p class="text-xs text-gray-500">Selesai/Ditolak</p>';
                }


                return `
                <div class="border border-gray-200 rounded-xl p-5 bg-white hover:shadow-md transition dark:bg-neutral-800 dark:border-neutral-700">
                    <div class="flex flex-col md:flex-row justify-between gap-4">
                        <div class="flex-1 space-y-2">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-3xl">${o.item_image && o.item_image.length < 5 ? o.item_image : 'üöú'}</span> 
                                <div>
                                    <h4 class="font-bold text-lg text-gray-800 dark:text-white">${o.item_name || 'Alat Berat'}</h4>
                                    <p class="text-xs text-gray-400 font-mono">Order ID: ${o.order_id} | Pelanggan: <b>${o.customer_name || 'N/A'}</b></p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-6 gap-y-2 text-sm text-gray-600 dark:text-gray-400">
                                <p>üìÖ Mulai: <b>${o.start_date ? o.start_date.split('T')[0] : '-'}</b></p>
                                <p>‚è±Ô∏è Durasi: <b>${o.duration}</b></p>
                                <p>üí∞ Total: <b class="text-orange-600">Rp ${parseInt(o.total_rental_fee).toLocaleString()}</b></p>
                            </div>

                            <div class="mt-3">
                                <span class="px-3 py-1 rounded-full text-xs font-bold border ${statusClass} inline-flex items-center gap-1">
                                    ${statusBadge}
                                </span>
                            </div>
                        </div>

                        <div class="flex flex-col gap-2 md:w-40">
                            <button onclick="viewAdminInvoice('${o.order_id}')" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-800 transition">
                                üìÑ Lihat Invoice
                            </button>
                            ${actionButton}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        // --- FUNGSI CRUD INVENTARIS (Placeholder) ---
        function deleteProduct(productId) {
            if (confirm(`Yakin ingin menghapus unit dengan ID ${productId}?`)) {
                alert('Fungsi Hapus Belum Diimplementasikan di API.');
                loadInventoryData();
            }
        }


        // --- LOGIKA TAB SWITCHING (Memastikan pemanggilan filter yang tepat) ---
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const targetId = tab.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    e.currentTarget.classList.add('active');

                    contents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    document.getElementById(`tab-${targetId}`).classList.remove('hidden');

                    if (targetId === 'order_management') {
                         document.getElementById('actionFilter').value = 'verification';
                         filterOrdersDisplay('verification');
                    } else if (targetId === 'inventory_list') {
                         loadInventoryData(); 
                    }
                });
            });
        }
        
        // --- FUNGSI MODAL, INVOICE, DAN LOGOUT (Tidak Berubah) ---
        window.openVerifyModal = (event) => {
            const button = event.currentTarget;
            const orderId = button.getAttribute('data-order-id');
            const customerName = button.getAttribute('data-customer-name');
            const documentPath = button.getAttribute('data-document-path');
            const isExtension = button.getAttribute('data-is-extension') === 'true';
            const extFee = button.getAttribute('data-extension-fee');
            const extDuration = button.getAttribute('data-extension-duration');

            document.getElementById('verifyOrderId').innerText = orderId;
            document.getElementById('verifyCustomerName').innerText = customerName;
            currentVerificationOrder = orderId;
            
            const docLink = document.getElementById('verifyDocumentLink');
            if (documentPath) {
                docLink.href = `${UPLOAD_URL}/${documentPath}`;
                docLink.innerText = 'Lihat Dokumen Pelanggan ‚ÜóÔ∏è';
                docLink.style.display = 'inline-block';
            } else {
                docLink.href = '#';
                docLink.innerText = 'Dokumen tidak tersedia/Tidak Wajib.';
                docLink.style.display = 'block';
            }

            const extWarningBlock = document.getElementById('extensionWarningBlock');
            const btnApprove = document.getElementById('btnApprove');

            if (isExtension) {
                extWarningBlock.classList.remove('hidden');
                
                const feeDisplay = parseFloat(extFee).toLocaleString('id-ID'); 
                
                document.getElementById('extFeeDisplay').innerText = `Rp ${feeDisplay}`;
                document.getElementById('extDurationDisplay').innerText = extDuration;
                
                btnApprove.innerText = '‚úÖ Setujui Perpanjangan';
            } else {
                extWarningBlock.classList.add('hidden');
                btnApprove.innerText = '‚úÖ Setujui & Ubah Status ke READY';
            }

            btnApprove.classList.remove('bg-green-600', 'hover:bg-green-700');
            btnApprove.classList.add('bg-gray-900', 'hover:bg-gray-800');

            document.getElementById('verifyModal').classList.remove('hidden');
        };

        window.closeVerifyModal = () => {
            document.getElementById('verifyModal').classList.add('hidden');
            currentVerificationOrder = null;
        };

        window.submitVerification = async (action) => {
            if (!currentVerificationOrder) return;
            
            const newStatus = action === 'approve' ? 'READY' : 'rejected'; 
            
            try {
                const res = await fetch(`${API_URL}/admin/update-order-status`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: currentVerificationOrder, status: newStatus })
                });
                
                const result = await res.json();
                
                if (result.success) {
                    alert(`‚úÖ Status pesanan ${currentVerificationOrder} berhasil diubah menjadi ${newStatus}.`);
                    closeVerifyModal();
                    loadOrdersByStatus('all_data'); 
                } else {
                    alert(`‚ùå Gagal: ${result.message}`);
                }

            } catch (error) {
                alert('‚ùå Terjadi kesalahan koneksi server saat verifikasi.');
            }
        };

        window.updateOrderStatus = async (orderId, status) => {
            if (!confirm(`Yakin ingin mengubah status pesanan ${orderId} menjadi ${status}?`)) return;
            
            try {
                const res = await fetch(`${API_URL}/admin/update-order-status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId, status })
                });
                const result = await res.json();

                if (result.success) {
                    alert(`‚úÖ Status pesanan ${orderId} berhasil diupdate.`);
                    loadOrdersByStatus('all_data'); 
                } else {
                    alert(`‚ùå Gagal update status: ${result.message}`);
                }
            } catch (error) {
                alert('‚ùå Terjadi kesalahan koneksi server.');
            }
        };

        window.viewAdminInvoice = async (orderId) => { /* ... */ };
        window.closeAdminInvoiceModal = () => { /* ... */ };
        function renderAdminInvoice(data) { /* ... */ }
        window.downloadAdminInvoice = async () => { /* ... */ };


        document.getElementById('logoutAdminBtn').addEventListener('click', () => {
            localStorage.removeItem('adminId');
            localStorage.removeItem('isAdminLoggedIn');
            window.location.href = '/login'; 
        });
    </script>
</MainLayout>