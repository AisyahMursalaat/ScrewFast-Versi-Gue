---
// admin/dashboard.astro
import MainLayout from "@/layouts/MainLayout.astro";

const pageTitle = "Panel Administrasi | RentHeavyPro";
---

<MainLayout title={pageTitle}>
    <div class="mx-auto max-w-[95rem] px-4 py-10 sm:px-6 lg:px-8">
        
        <div class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-200 dark:border-neutral-700 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-800 dark:text-white">Panel Administrasi</h1>
                <p class="text-gray-500 text-sm mt-1">Kelola **Semua Pesanan**, Verifikasi Pembayaran, dan Status Unit.</p>
            </div>
            <div class="flex gap-3">
                <a href="/admin/inventory" class="bg-blue-100 text-blue-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-200 transition">‚öôÔ∏è Kelola Unit</a>
                <button id="logoutAdminBtn" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-200 transition">Logout Admin</button>
            </div>
        </div>

        <div class="bg-white border border-gray-200 rounded-xl shadow-lg dark:bg-neutral-900 dark:border-neutral-700">
            
            <nav class="flex space-x-2 p-4 border-b border-gray-200 dark:border-neutral-700" role="tablist">
                <button type="button" class="tab-button inline-flex items-center gap-x-2 py-2 px-3 text-sm font-medium rounded-lg text-gray-800 hover:text-blue-600 dark:text-gray-200 dark:hover:text-blue-500 active" data-tab="verification">
                    üìã Verifikasi & Perpanjangan
                </button>
                <button type="button" class="tab-button inline-flex items-center gap-x-2 py-2 px-3 text-sm font-medium rounded-lg text-gray-800 hover:text-blue-600 dark:text-gray-200 dark:hover:text-blue-500" data-tab="active_units">
                    üì¶ Kelola Unit Aktif
                </button>
                <button type="button" class="tab-button inline-flex items-center gap-x-2 py-2 px-3 text-sm font-medium rounded-lg text-gray-800 hover:text-blue-600 dark:text-gray-200 dark:hover:text-blue-500" data-tab="gps">
                    üì° GPS Tracking (Simulasi)
                </button>
            </nav>

            <div class="p-6">
                
                <div id="tab-verification" class="tab-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-700 dark:text-gray-200">Pesanan Baru & Permintaan Perpanjangan</h3>
                        <button onclick="loadOrdersByStatus('all')" class="text-xs text-blue-600 hover:underline flex items-center gap-1">
                            üîÑ Muat Ulang Daftar
                        </button>
                    </div>
                    <div id="allOrderList" class="space-y-4 min-h-[300px]">
                        <p class="text-center text-gray-500 py-10 animate-pulse">Sedang memuat data...</p>
                    </div>
                </div>

                <div id="tab-active_units" class="tab-content hidden">
                    <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-4">Unit Saat Ini dalam Penyewaan (READY / active)</h3>
                    <div id="activeUnitList" class="space-y-4 min-h-[300px]">
                        <p class="text-center text-gray-500 py-10">Memuat data unit aktif...</p>
                    </div>
                </div>

                <div id="tab-gps" class="tab-content hidden">
                    <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-4">Simulasi Lokasi Unit</h3>
                    <div class="bg-gray-100 dark:bg-neutral-800 p-8 rounded-lg min-h-[300px] flex items-center justify-center">
                        <p class="text-gray-500">üìç (Data GPS Simulasi: Fitur ini membutuhkan API Map pihak ketiga.)</p>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <div id="verifyModal" class="fixed inset-0 z-[999] hidden bg-black/80 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-neutral-900 w-full max-w-lg rounded-2xl shadow-2xl">
            <div class="p-5 bg-gray-900 rounded-t-2xl flex justify-between items-center">
                <h3 class="font-bold text-xl text-white">‚úÖ Verifikasi Pesanan / Perpanjangan</h3>
                <button onclick="closeVerifyModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-sm text-gray-700">Order ID: <b id="verifyOrderId">#TRX-000</b></p>
                <p class="text-sm text-gray-700">Pelanggan: <b id="verifyCustomerName">-</b></p>
                <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg hidden" id="extensionWarningBlock">
                    <p class="text-xs font-bold text-blue-900 mb-1">DETAIL PERPANJANGAN:</p>
                    <p class="text-sm text-blue-700">Durasi Tambahan: <b id="extDurationDisplay">-</b></p>
                    <p class="text-sm text-red-700 font-bold">Biaya Tambahan: <b id="extFeeDisplay">-</b></p>
                </div>
                
                <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-xs font-bold text-red-700 mb-2">DOKUMEN:</p>
                    <a id="verifyDocumentLink" href="#" target="_blank" class="text-sm text-blue-600 font-bold hover:underline">
                        Lihat Dokumen Pelanggan ‚ÜóÔ∏è
                    </a>
                </div>

                <p class="text-base font-bold mt-4">Pilih Aksi:</p>
                
                <div class="flex gap-4">
                    <button id="btnApprove" onclick="submitVerification('approve')" 
                            class="flex-1 bg-gray-900 text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition">
                        ‚úÖ Setujui & Ubah Status ke READY
                    </button>
                    <button id="btnReject" onclick="submitVerification('reject')" 
                            class="flex-1 bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition">
                        ‚ùå Tolak
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="adminInvoiceModal" class="fixed inset-0 z-[999] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white dark:bg-neutral-900 w-full max-w-2xl rounded-2xl shadow-2xl my-8">
            <div class="p-5 border-b border-gray-200 dark:border-neutral-700 flex justify-between items-center bg-gray-900 rounded-t-2xl">
                <h3 class="font-bold text-xl text-white">üìÑ Invoice Pesanan (Admin View)</h3>
                <button onclick="closeAdminInvoiceModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>

            <div id="adminInvoiceContent" class="p-8 space-y-6">
                </div>

            <div class="p-5 border-t bg-gray-50 flex gap-3">
                <button onclick="closeAdminInvoiceModal()" class="flex-1 bg-gray-200 text-gray-800 font-bold py-2.5 rounded-lg hover:bg-gray-300 transition">
                    Tutup
                </button>
                <button onclick="downloadAdminInvoice()" class="flex-1 bg-gray-900 text-white font-bold py-2.5 rounded-lg hover:bg-gray-800 transition shadow-md">
                    üì• Download PDF
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        const API_URL = 'http://localhost:5000/api'; 
        const UPLOAD_URL = 'http://localhost:5000/uploads';
        
        const adminId = localStorage.getItem('adminId');

        // Otentikasi
        if (!adminId || localStorage.getItem('isAdminLoggedIn') !== 'true') {
            window.location.href = '/login'; 
        } else {
            loadOrdersByStatus('all'); 
            setupTabs();
        }

        let currentVerificationOrder = null;
        let currentAdminInvoiceOrder = null;
        
        // --- LOGIKA UTAMA LOADING DATA BERDASARKAN STATUS ---
        async function loadOrdersByStatus(statusFilter = 'all') {
            const targetId = statusFilter === 'active_units' ? 'activeUnitList' : 'allOrderList';
            const targetElement = document.getElementById(targetId);

            targetElement.innerHTML = '<p class="text-center text-gray-500 py-10 animate-pulse">Sedang memuat data...</p>';

            try {
                const res = await fetch(`${API_URL}/orders`); 
                
                if (!res.ok) {
                    console.error('API /orders failed:', res.status, await res.text());
                    throw new Error('Gagal memuat data dari API /orders.');
                }
                
                const allOrders = await res.json();
                
                let filteredOrders = allOrders;

                if (statusFilter === 'active_units') {
                    filteredOrders = allOrders.filter(o => o.status === 'active' || o.status === 'READY');
                } else {
                    filteredOrders = allOrders.filter(o => 
                        o.status === 'pending_verification' || 
                        o.status === 'PAID_VERIFY' || 
                        o.status === 'EXTENDED' ||
                        o.status === 'rejected' ||
                        o.status === 'COMPLETED'
                    );
                }

                renderOrderList(filteredOrders, targetElement);

            } catch (error) {
                console.error('Gagal memuat pesanan Admin:', error);
                targetElement.innerHTML = '<p class="text-center text-red-500 py-10">‚ùå Gagal memuat data. Cek koneksi server atau database.</p>';
            } 
        }

        function renderOrderList(data, targetElement) {
            if (data.length === 0) {
                targetElement.innerHTML = '<p class="text-center py-10 text-gray-500">Tidak ada pesanan di status ini.</p>';
                return;
            }

            targetElement.innerHTML = data.map(o => {
                let statusBadge = "";
                let statusClass = "";
                let actionButton = "";
                // Tombol aksi di daftar (Verifikasi/Cek Perpanjangan) juga diubah ke hitam
                let buttonColor = "bg-gray-900 hover:bg-gray-800"; 
                
                const currentTotalFee = parseFloat(o.total_rental_fee) || 0;
                
                // Pastikan nilai string yang dikirim ke modal tidak null
                const customerNameSafe = o.customer_name ? o.customer_name.replace(/'/g, "\\'") : 'N/A'; 
                const documentPathSafe = o.ktp_sim_image || '';

                let modalData = `data-order-id='${o.order_id}' data-customer-name='${customerNameSafe}' data-document-path='${documentPathSafe}'`;

                if(o.status === 'pending_verification' || o.status === 'PAID_VERIFY') {
                    statusBadge = "‚è≥ Verifikasi Pembayaran/Dokumen";
                    statusClass = "bg-yellow-100 text-yellow-800 border-yellow-200";
                    actionButton = `<button onclick="openVerifyModal(event)" ${modalData} class="${buttonColor} text-white px-4 py-2 rounded-lg text-sm font-bold transition">
                                        ‚úÖ Verifikasi
                                    </button>`;
                } else if (o.status === 'active' || o.status === 'READY') {
                    statusBadge = "‚úÖ Unit Aktif / Siap Kirim";
                    statusClass = "bg-green-100 text-green-800 border-green-200";
                    actionButton = `<button onclick="updateOrderStatus('${o.order_id}', 'COMPLETED')" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition">
                                        ‚úÖ Selesai Sewa
                                    </button>`;
                } else if (o.status === 'EXTENDED') {
                    statusBadge = "üîÑ PERPANJANGAN MENUNGGU";
                    statusClass = "bg-blue-100 text-blue-800 border-blue-200";
                    
                    modalData += ` data-is-extension='true' data-extension-duration='${o.duration}'`;
                    modalData += ` data-extension-fee='${currentTotalFee}'`; 

                    actionButton = `<button onclick="openVerifyModal(event)" ${modalData} class="${buttonColor} text-white px-4 py-2 rounded-lg text-sm font-bold transition">
                                        ‚û°Ô∏è Cek Perpanjangan
                                    </button>`;
                } else if (o.status === 'rejected' || o.status === 'COMPLETED') {
                    statusBadge = o.status === 'rejected' ? "‚ùå Ditolak Admin" : "‚úîÔ∏è Selesai";
                    statusClass = o.status === 'rejected' ? "bg-red-100 text-red-800 border-red-200" : "bg-gray-100 text-gray-600 border-gray-200";
                    actionButton = '<p class="text-xs text-gray-500">Aksi Selesai</p>';
                }

                return `
                <div class="border border-gray-200 rounded-xl p-5 bg-white hover:shadow-md transition dark:bg-neutral-800 dark:border-neutral-700">
                    <div class="flex flex-col md:flex-row justify-between gap-4">
                        <div class="flex-1 space-y-2">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-3xl">${o.item_image && o.item_image.length < 5 ? o.item_image : 'üöú'}</span> 
                                <div>
                                    <h4 class="font-bold text-lg text-gray-800 dark:text-white">${o.item_name || 'Alat Berat'}</h4>
                                    <p class="text-xs text-gray-400 font-mono">Order ID: ${o.order_id} | Pelanggan: <b>${o.customer_name || 'N/A'}</b></p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-6 gap-y-2 text-sm text-gray-600 dark:text-gray-400">
                                <p>üìÖ Mulai: <b>${o.start_date ? o.start_date.split('T')[0] : '-'}</b></p>
                                <p>‚è±Ô∏è Durasi: <b>${o.duration}</b></p>
                                <p>üí∞ Total: <b class="text-orange-600">Rp ${parseInt(o.total_rental_fee).toLocaleString()}</b></p>
                            </div>

                            <div class="mt-3">
                                <span class="px-3 py-1 rounded-full text-xs font-bold border ${statusClass} inline-flex items-center gap-1">
                                    ${statusBadge}
                                </span>
                            </div>
                        </div>

                        <div class="flex flex-col gap-2 md:w-40">
                            <button onclick="viewAdminInvoice('${o.order_id}')" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-800 transition">
                                üìÑ Lihat Invoice
                            </button>
                            ${actionButton}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        // --- LOGIKA MODAL DAN AKSI ADMIN ---
        window.openVerifyModal = (event) => {
            const button = event.currentTarget;
            const orderId = button.getAttribute('data-order-id');
            const customerName = button.getAttribute('data-customer-name');
            const documentPath = button.getAttribute('data-document-path');
            const isExtension = button.getAttribute('data-is-extension') === 'true';
            const extFee = button.getAttribute('data-extension-fee');
            const extDuration = button.getAttribute('data-extension-duration');

            document.getElementById('verifyOrderId').innerText = orderId;
            document.getElementById('verifyCustomerName').innerText = customerName;
            currentVerificationOrder = orderId;
            
            const docLink = document.getElementById('verifyDocumentLink');
            if (documentPath) {
                docLink.href = `${UPLOAD_URL}/${documentPath}`;
                docLink.innerText = 'Lihat Dokumen Pelanggan ‚ÜóÔ∏è';
                docLink.style.display = 'inline-block';
            } else {
                docLink.href = '#';
                docLink.innerText = 'Dokumen tidak tersedia/Tidak Wajib.';
                docLink.style.display = 'block';
            }

            const extWarningBlock = document.getElementById('extensionWarningBlock');
            const btnApprove = document.getElementById('btnApprove');

            // Logika UI Perpanjangan
            if (isExtension) {
                extWarningBlock.classList.remove('hidden');
                
                const feeDisplay = parseFloat(extFee).toLocaleString('id-ID'); 
                
                document.getElementById('extFeeDisplay').innerText = `Rp ${feeDisplay}`;
                document.getElementById('extDurationDisplay').innerText = extDuration;
                
                btnApprove.innerText = '‚úÖ Setujui Perpanjangan';
                // Ubah warna tombol persetujuan di modal juga
                btnApprove.classList.remove('bg-green-600', 'hover:bg-green-700');
                btnApprove.classList.add('bg-gray-900', 'hover:bg-gray-800');

            } else {
                extWarningBlock.classList.add('hidden');
                btnApprove.innerText = '‚úÖ Setujui & Ubah Status ke READY';
                 // Kembalikan warna tombol ke hitam untuk Verifikasi Normal
                btnApprove.classList.remove('bg-green-600', 'hover:bg-green-700');
                btnApprove.classList.add('bg-gray-900', 'hover:bg-gray-800');
            }

            document.getElementById('verifyModal').classList.remove('hidden');
        };

        window.closeVerifyModal = () => {
            document.getElementById('verifyModal').classList.add('hidden');
            currentVerificationOrder = null;
        };

        // FUNGSI SUBMIT VERIFIKASI (untuk pesanan baru/perpanjangan)
        window.submitVerification = async (action) => {
            if (!currentVerificationOrder) return;
            
            const btnApprove = document.getElementById('btnApprove');
            const btnReject = document.getElementById('btnReject');
            
            const originalTextApprove = btnApprove.innerText;
            const originalTextReject = btnReject.innerText;
            
            btnApprove.disabled = true;
            btnReject.disabled = true;
            
            if (action === 'approve') {
                btnApprove.innerText = 'Memproses...';
            } else {
                btnReject.innerText = 'Memproses...';
            }
            
            const newStatus = action === 'approve' ? 'READY' : 'rejected'; 
            
            try {
                // Menggunakan endpoint /admin/update-order-status dari server.js
                const res = await fetch(`${API_URL}/admin/update-order-status`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        orderId: currentVerificationOrder, 
                        status: newStatus 
                    })
                });
                
                const result = await res.json();
                
                if (result.success) {
                    alert(`‚úÖ Status pesanan ${currentVerificationOrder} berhasil diubah menjadi ${newStatus}.`);
                    closeVerifyModal();
                    loadOrdersByStatus('all'); 
                } else {
                    alert(`‚ùå Gagal: ${result.message}`);
                }

            } catch (error) {
                console.error('Error saat verifikasi:', error);
                alert('‚ùå Terjadi kesalahan koneksi server saat verifikasi.');
            } finally {
                btnApprove.disabled = false;
                btnReject.disabled = false;
                btnApprove.innerText = originalTextApprove;
                btnReject.innerText = originalTextReject;
            }
        };

        // FUNGSI UMUM UPDATE STATUS (untuk COMPLETED)
        window.updateOrderStatus = async (orderId, status) => {
            if (!confirm(`Yakin ingin mengubah status pesanan ${orderId} menjadi ${status}?`)) return;
            
            try {
                const res = await fetch(`${API_URL}/admin/update-order-status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId, status })
                });
                const result = await res.json();

                if (result.success) {
                    alert(`‚úÖ Status pesanan ${orderId} berhasil diupdate.`);
                    loadOrdersByStatus('active_units'); 
                } else {
                    alert(`‚ùå Gagal update status: ${result.message}`);
                }
            } catch (error) {
                console.error('Error saat update status:', error);
                alert('‚ùå Terjadi kesalahan koneksi server.');
            }
        };


        // LOGIKA TAB SWITCHING
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const targetId = tab.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    e.currentTarget.classList.add('active');

                    contents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    document.getElementById(`tab-${targetId}`).classList.remove('hidden');

                    if (targetId === 'active_units') {
                         loadOrdersByStatus('active_units');
                    } else if (targetId === 'verification') {
                         loadOrdersByStatus('all');
                    }
                });
            });
        }
        
        // FUNGSI INVOICE
        window.viewAdminInvoice = async (orderId) => {
             try {
                const res = await fetch(`${API_URL}/invoice/${orderId}`);
                const result = await res.json();
                
                if (!result.success) {
                    alert('‚ùå Invoice tidak ditemukan');
                    return;
                }
                
                currentAdminInvoiceOrder = result.data;
                renderAdminInvoice(result.data);
                document.getElementById('adminInvoiceModal').classList.remove('hidden');
            } catch (error) {
                console.error(error);
                alert('‚ùå Gagal memuat invoice');
            }
        };

        window.closeAdminInvoiceModal = () => {
            document.getElementById('adminInvoiceModal').classList.add('hidden');
            currentAdminInvoiceOrder = null;
        };
        
        function renderAdminInvoice(data) {
            const content = document.getElementById('adminInvoiceContent');
            const invoiceDate = new Date(data.created_at).toLocaleDateString('id-ID', { 
                year: 'numeric', month: 'long', day: 'numeric' 
            });
            
            content.innerHTML = `
                <div class="text-center border-b pb-6">
                    <h1 class="text-3xl font-bold text-gray-900">INVOICE</h1>
                    <p class="text-gray-500 mt-1">PT RentHeavyPro Indonesia</p>
                    <p class="text-sm text-gray-400">Jl. Industri Berat No. 123, Jakarta</p>
                </div>

                <div class="grid grid-cols-2 gap-6 my-6">
                    <div>
                        <p class="text-xs text-gray-500 font-bold mb-2">INVOICE TO:</p>
                        <p class="font-bold text-gray-900">${data.customer_name}</p>
                        <p class="text-sm text-gray-600">${data.project_loc}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500 font-bold mb-2">INVOICE DETAILS:</p>
                        <p class="text-sm"><span class="font-bold">No:</span> ${data.order_id}</p>
                        <p class="text-sm"><span class="font-bold">Tanggal:</span> ${invoiceDate}</p>
                        <p class="text-sm"><span class="font-bold">Status:</span> 
                            <span class="px-2 py-0.5 rounded text-xs font-bold ${
                                data.status === 'READY' || data.status === 'active' ? 'bg-green-100 text-green-700' : 
                                data.status === 'PAID_VERIFY' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'
                            }">${data.status}</span>
                        </p>
                    </div>
                </div>

                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold">Item</th>
                            <th class="border border-gray-300 px-4 py-3 text-center text-sm font-bold">Durasi</th>
                            <th class="border border-gray-300 px-4 py-3 text-center text-sm font-bold">Mulai</th>
                            <th class="border border-gray-300 px-4 py-3 text-right text-sm font-bold">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border border-gray-300 px-4 py-3">
                                <p class="font-bold text-gray-900">${data.item_name}</p>
                                <p class="text-xs text-gray-500">Sewa Alat Berat - Lepas Kunci</p>
                            </td>
                            <td class="border border-gray-300 px-4 py-3 text-center">${data.duration}</td>
                            <td class="border border-gray-300 px-4 py-3 text-center">${data.start_date.split('T')[0]}</td>
                            <td class="border border-gray-300 px-4 py-3 text-right font-bold">
                                Rp ${parseInt(data.total_rental_fee).toLocaleString()}
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="bg-gray-50">
                            <td colspan="3" class="border border-gray-300 px-4 py-3 text-right font-bold">TOTAL:</td>
                            <td class="border border-gray-300 px-4 py-3 text-right font-bold text-lg text-orange-600">
                                Rp ${parseInt(data.total_rental_fee).toLocaleString()}
                            </td>
                        </tr>
                    </tfoot>
                </table>

                <div class="mt-8 text-center text-xs text-gray-400">
                    <p>Dokumen ini dibuat secara otomatis dan sah tanpa tanda tangan</p>
                </div>
            `;
        }

        window.downloadAdminInvoice = async () => {
             if (!currentAdminInvoiceOrder) return;
            
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = '‚è≥ Generating PDF...';
            btn.disabled = true;

            try {
                const invoiceElement = document.getElementById('adminInvoiceContent');
                
                const canvas = await html2canvas(invoiceElement, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                const imgData = canvas.toDataURL('image/png');
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                
                pdf.save(`Invoice_Admin_${currentAdminInvoiceOrder.order_id}.pdf`);
                
                alert('‚úÖ Invoice berhasil didownload!');
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('‚ùå Gagal generate PDF. Mencoba metode print...');
            }
            
            btn.innerText = originalText;
            btn.disabled = false;
        };


        document.getElementById('logoutAdminBtn').addEventListener('click', () => {
            localStorage.removeItem('adminId');
            localStorage.removeItem('isAdminLoggedIn');
            window.location.href = '/admin/login'; 
        });
    </script>
</MainLayout>