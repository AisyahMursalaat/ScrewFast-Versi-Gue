---
import MainLayout from "@/layouts/MainLayout.astro";
const pageTitle = "Katalog Unit | RentHeavyPro";
---

<MainLayout title={pageTitle}>
  <div class="mx-auto max-w-[85rem] px-4 py-10 lg:py-14">
    <div class="text-center mb-10">
      <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Katalog Armada (PB-01)</h2>
      <p class="text-gray-500 mt-2">Unit dari Database sdb_rent.</p>
      
      <div class="mt-6 flex justify-center gap-4">
         <input type="text" id="searchInput" placeholder="ðŸ” Cari nama alat..." class="border p-3 rounded-lg w-64 shadow-sm outline-none focus:ring-2 focus:ring-orange-500">
         <select id="catFilter" class="border p-3 rounded-lg shadow-sm bg-white outline-none focus:ring-2 focus:ring-orange-500">
            <option value="all">Semua Kategori</option>
            <option value="Heavy">Heavy Duty</option>
            <option value="Light">Light Duty</option>
         </select>
      </div>
    </div>

    <div id="productGrid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
       <div class="col-span-full text-center py-10 text-gray-500">Mengambil Data dari Backend...</div>
    </div>
  </div>

  <div id="rentModal" class="fixed inset-0 z-[999] hidden bg-black/60 flex items-center justify-center p-4 overflow-y-auto">
     <div class="bg-white w-full max-w-lg rounded-xl p-6 dark:bg-neutral-900 my-8">
        
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="font-bold text-xl text-gray-800 dark:text-white">Formulir Sewa</h3>
            <button id="closeModal" class="text-gray-500 text-2xl">&times;</button>
        </div>
        
        <div class="flex items-center gap-4 mb-4 bg-blue-50 p-3 rounded">
           <div id="mIcon" class="text-3xl">ðŸšœ</div>
           <div>
              <h4 id="mName" class="font-bold text-gray-800">Nama Unit</h4>
              <p id="mPrice" class="text-sm text-orange-600">Rp 0 / hari</p>
              <input type="hidden" id="mPriceRaw">
              <input type="hidden" id="mProductId">
           </div>
        </div>
        
        <form id="rentalForm" class="space-y-4">
           <div>
               <label class="block text-sm font-bold mb-1">Nama Penyewa</label>
               <input id="inpName" type="text" class="w-full border p-2 rounded" required>
           </div>
           <div>
               <label class="block text-sm font-bold mb-1">Lokasi Proyek</label>
               <textarea id="inpAddr" class="w-full border p-2 rounded" rows="2" required></textarea>
           </div>
           
           <div class="grid grid-cols-2 gap-3">
              <div>
                  <label class="block text-sm font-bold mb-1">Mulai Tanggal</label>
                  <input id="inpDate" type="date" class="w-full border p-2 rounded" required>
              </div>
              <div>
                  <label class="block text-sm font-bold mb-1">Durasi</label>
                  <div class="flex">
                      <input id="inpDur" type="number" value="1" min="1" class="w-16 border p-2 rounded-l text-center" required>
                      <select id="inpType" class="w-full border p-2 rounded-r bg-gray-100 font-bold text-sm">
                         <option value="Hari">Hari</option>
                         <option value="Bulan">Bulan</option>
                      </select>
                  </div>
              </div>
           </div>

           <div class="border-2 border-dashed border-gray-300 p-4 rounded text-center bg-gray-50">
               <p class="text-sm font-bold mb-2">Upload SIM B2 Umum / SIO (Wajib)</p>
               <input id="inpFile" type="file" accept="image/*,.pdf" class="w-full text-sm" required>
           </div>
           
           <div id="paymentUI" class="hidden border-t pt-4 mt-4 bg-green-50 p-3 rounded text-center">
              <p class="text-sm font-bold text-green-800">Pembayaran Terverifikasi Otomatis âœ…</p>
              <p class="text-xs text-gray-500">Sistem mendeteksi pembayaran lunas.</p>
           </div>

           <div class="text-right font-bold text-lg text-blue-600 mt-2">
              Total: <span id="totalTxt">Rp 0</span>
           </div>
           
           <button type="submit" id="btnSubmit" class="w-full bg-orange-600 text-white font-bold py-3 rounded hover:bg-orange-700 mt-2">Bayar & Sewa</button>
        </form>
     </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';
    let allProducts = [];

    // --- PB-01: Fetch Data dari Database ---
    async function loadProducts() {
       try {
          const res = await fetch(`${API_URL}/products`);
          allProducts = await res.json();
          renderGrid(allProducts);
       } catch (e) {
          document.getElementById('productGrid').innerHTML = '<p class="text-red-500 col-span-full text-center">Gagal Konek Backend (Port 5000)</p>';
       }
    }

    function renderGrid(data) {
        const grid = document.getElementById('productGrid');
        if(data.length === 0) { grid.innerHTML = '<p class="col-span-full text-center">Data Kosong.</p>'; return; }

        grid.innerHTML = data.map(p => `
             <div class="border rounded-xl overflow-hidden shadow-sm bg-white hover:shadow-lg transition group">
                <div class="h-48 bg-gray-100 flex items-center justify-center text-6xl">
                    ${p.image.length < 5 ? p.image : 'ðŸ“·'}
                </div>
                <div class="p-5">
                   <h3 class="font-bold text-lg text-gray-800 dark:text-white">${p.name}</h3>
                   <p class="text-sm text-gray-500 mb-2">${p.category}</p>
                   <p class="text-orange-600 font-bold text-xl">Rp ${parseInt(p.price).toLocaleString()}/hari</p>
                   <button onclick="openModal(${p.id}, '${p.name}', ${p.price}, '${p.image}')" class="w-full mt-4 bg-gray-900 text-white py-2 rounded font-bold hover:bg-gray-800 transition">Sewa</button>
                </div>
             </div>
        `).join('');
    }

    // --- PB-02: Filter Mobil ---
    function filterProducts() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('catFilter').value;
        const filtered = allProducts.filter(p => {
            const matchName = p.name.toLowerCase().includes(term);
            const matchCat = cat === 'all' || p.category === cat;
            return matchName && matchCat;
        });
        renderGrid(filtered);
    }
    document.getElementById('searchInput').addEventListener('input', filterProducts);
    document.getElementById('catFilter').addEventListener('change', filterProducts);

    // --- MODAL LOGIC ---
    const modal = document.getElementById('rentModal');
    const form = document.getElementById('rentalForm');
    const btnSubmit = document.getElementById('btnSubmit');
    const paymentUI = document.getElementById('paymentUI');
    const mPriceRaw = document.getElementById('mPriceRaw');
    const inpDur = document.getElementById('inpDur');
    const inpType = document.getElementById('inpType');
    const totalTxt = document.getElementById('totalTxt');

    window.openModal = (id, name, price, img) => {
       document.getElementById('mName').innerText = name;
       document.getElementById('mPrice').innerText = `Rp ${parseInt(price).toLocaleString()} / hari`;
       document.getElementById('mIcon').innerText = img.length < 5 ? img : 'ðŸ“·';
       document.getElementById('mProductId').value = id;
       mPriceRaw.value = price;
       
       form.reset();
       paymentUI.classList.add('hidden');
       btnSubmit.innerText = "Bayar & Sewa";
       btnSubmit.disabled = false;
       modal.classList.remove('hidden');
       calcTotal();
    };
    
    document.getElementById('closeModal').onclick = () => modal.classList.add('hidden');

    // Hitung Harga
    function calcTotal() {
       const p = parseInt(mPriceRaw.value);
       const d = parseInt(inpDur.value);
       const t = inpType.value;
       let total = (t === 'Bulan') ? (p * 30 * d) * 0.9 : p * d;
       totalTxt.innerText = `Rp ${total.toLocaleString()}`;
    }
    inpDur.addEventListener('input', calcTotal);
    inpType.addEventListener('change', calcTotal);

    // --- PB-08 & PB-09: Submit dengan Upload File ---
    form.addEventListener('submit', async (e) => {
       e.preventDefault();
       
       // Simulasi Pembayaran
       if(paymentUI.classList.contains('hidden')) {
           btnSubmit.innerText = "Memproses Pembayaran...";
           setTimeout(() => {
               paymentUI.classList.remove('hidden');
               btnSubmit.innerText = "Konfirmasi Pesanan";
           }, 1500);
           return;
       }

       // Kirim ke Backend
       const formData = new FormData();
       formData.append('customer_name', document.getElementById('inpName').value);
       formData.append('project_loc', document.getElementById('inpAddr').value);
       formData.append('product_id', document.getElementById('mProductId').value);
       formData.append('start_date', document.getElementById('inpDate').value);
       formData.append('duration', `${inpDur.value} ${inpType.value}`);
       formData.append('total_rental_fee', totalTxt.innerText.replace(/\D/g, ''));
       formData.append('doc_sim', document.getElementById('inpFile').files[0]);

       try {
          const res = await fetch(`${API_URL}/checkout`, { method: 'POST', body: formData });
          const result = await res.json();
          if(result.success) {
              alert('âœ… Pesanan Berhasil Masuk Database!\nMenunggu Verifikasi Admin.');
              modal.classList.add('hidden');
              window.location.reload();
          } else {
              alert('Gagal: ' + result.message);
          }
       } catch (err) { alert('Error Server'); }
    });

    loadProducts();
  </script>
</MainLayout>