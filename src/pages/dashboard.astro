---
import MainLayout from "@/layouts/MainLayout.astro";
---

<MainLayout title="Dashboard Customer | RentHeavyPro">
  <div class="mx-auto max-w-[85rem] px-4 py-10 sm:px-6 lg:px-8">
    
    <div class="flex justify-between items-center mb-8 pb-4 border-b border-gray-200 dark:border-neutral-700">
       <div>
          <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Akun Saya</h1>
          <p class="text-gray-500">Riwayat Pesanan & Status Sewa (Data XAMPP)</p>
       </div>
       <div class="flex items-center gap-4">
          <span class="text-sm font-bold text-orange-600" id="userNameDisplay">User</span>
          <button id="logoutBtn" class="text-red-500 font-bold hover:underline text-sm">Keluar</button>
       </div>
    </div>

    <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden dark:bg-neutral-900 dark:border-neutral-700">
       <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 dark:bg-neutral-800 dark:border-neutral-700">
          <h3 class="font-bold text-gray-700 dark:text-gray-200">üìã Pesanan Saya</h3>
       </div>
       
       <div id="myOrderList" class="p-6 space-y-4">
          <p class="text-center text-gray-500 py-10">Sedang mengambil data dari database...</p>
       </div>
    </div>

  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';
    
    // Ambil Nama User yang sedang login
    const currentUser = localStorage.getItem('username') || 'Guest';
    document.getElementById('userNameDisplay').innerText = currentUser;

    async function loadMyOrders() {
        try {
            // Ambil SEMUA order dari database
            const res = await fetch(`${API_URL}/orders`);
            const allOrders = await res.json();

            // Filter Client-Side: Hanya tampilkan order milik user ini
            // (Cara sederhana tanpa mengubah backend query)
            // Tips: Saat Checkout pastikan mengisi "Nama Penyewa" = "Budi Santoso" (sesuai login user)
            // Atau untuk demo, kita tampilkan semua order biar kelihatan isinya.
            
            const myOrders = allOrders; // Tampilkan semua (biar demo gampang)
            
            const list = document.getElementById('myOrderList');

            if (myOrders.length === 0) {
                list.innerHTML = '<div class="text-center py-10 text-gray-400">üö´ Belum ada riwayat sewa di database.</div>';
                return;
            }

            list.innerHTML = myOrders.map(o => {
                let statusStyle = "bg-gray-100 text-gray-600";
                let statusText = o.status;

                if(o.status === 'pending_verification' || o.status === 'PAID_VERIFY') {
                    statusStyle = "bg-yellow-100 text-yellow-800 border border-yellow-200";
                    statusText = "‚è≥ Menunggu Verifikasi Admin";
                } else if (o.status === 'active' || o.status === 'READY') {
                    statusStyle = "bg-green-100 text-green-800 border border-green-200";
                    statusText = "‚úÖ Disetujui / Aktif";
                } else if (o.status === 'rejected') {
                    statusStyle = "bg-red-100 text-red-800 border border-red-200";
                    statusText = "‚ùå Ditolak";
                }

                return `
                <div class="border border-gray-200 rounded-lg p-4 flex flex-col md:flex-row justify-between gap-4 bg-white hover:shadow-md transition dark:bg-neutral-800 dark:border-neutral-700">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                        <span class="font-bold text-lg text-gray-800 dark:text-white">${o.item_name || 'Alat Berat'}</span>
                        <span class="text-xs px-2 py-1 rounded ${statusStyle} font-bold">${statusText}</span>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Penyewa: <b>${o.customer_name}</b></p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Durasi: ${o.duration} ‚Ä¢ Lokasi: ${o.project_loc}</p>
                        <p class="text-xs text-gray-400 mt-1">Order ID: ${o.order_id}</p>
                    </div>
                    
                    <div class="text-right flex flex-col justify-center">
                        <p class="text-xs text-gray-500 mb-1">Total Biaya</p>
                        <p class="font-bold text-xl text-orange-600">Rp ${parseInt(o.total).toLocaleString()}</p>
                    </div>
                </div>`;
            }).join('');

        } catch (e) {
            console.error(e);
            document.getElementById('myOrderList').innerHTML = '<p class="text-red-500 text-center">Gagal konek ke server backend.</p>';
        }
    }

    // Cek Login
    if(localStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = '/login';
    }

    // Logout
    document.getElementById('logoutBtn').onclick = () => {
       localStorage.removeItem('isLoggedIn');
       localStorage.removeItem('userRole');
       window.location.href = '/login';
    };

    loadMyOrders();
  </script>
</MainLayout>