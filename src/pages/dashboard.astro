---
import MainLayout from "@/layouts/MainLayout.astro";
---

<MainLayout title="Pesanan Saya | RentHeavyPro">
  <div class="mx-auto max-w-[85rem] px-4 py-10 sm:px-6 lg:px-8">
    
    <div class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-200 dark:border-neutral-700 gap-4">
       <div>
          <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Akun Saya</h1>
          <p class="text-gray-500 text-sm mt-1">Halo, <span id="userNameDisplay" class="font-bold text-orange-600">...</span></p>
       </div>
       <div class="flex gap-3">
          <a href="/products" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-800 transition">‚ûï Sewa Lagi</a>
          <button id="logoutBtn" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-200 transition">Logout</button>
       </div>
    </div>

    <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden dark:bg-neutral-900 dark:border-neutral-700">
       <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 dark:bg-neutral-800 dark:border-neutral-700 flex justify-between items-center">
          <h3 class="font-bold text-gray-700 dark:text-gray-200">üìã Riwayat Pesanan Saya</h3>
          <button onclick="loadMyOrders()" 
          class="text-xs text-blue-600 hover:underline flex items-center gap-1">üîÑ Refresh Status</button>
       </div>
       
       <div id="myOrderList" class="p-6 space-y-4 min-h-[200px]">
          <p class="text-center text-gray-500 py-10 animate-pulse">Sedang memuat data dari database...</p>
       </div>
    </div>

  </div>

  <script>
    // URL API Backend
    const API_URL = 'http://localhost:5000/api';
    
    // 1. CEK LOGIN & AMBIL ID USER
    const userId = localStorage.getItem('userId');
    const userName = localStorage.getItem('username');

    if (!userId || localStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = '/login';
    } else {
        document.getElementById('userNameDisplay').innerText = userName || 'Pelanggan';
        loadMyOrders();
    }

    // 2. FETCH PESANAN KHUSUS UNTUK USER INI (PB-12)
    async function loadMyOrders() {
        const list = document.getElementById('myOrderList');
        try {
            // Memanggil API baru yang sudah kita buat
            const res = await fetch(`${API_URL}/my-orders/${userId}`);
            const myOrders = await res.json();

            if (myOrders.length === 0) {
                list.innerHTML = `
                <div class="text-center py-10">
                   <p class="text-4xl mb-2">üì≠</p>
                   <p class="text-gray-500">Belum ada riwayat sewa.</p>
                   <a href="/products" class="text-orange-600 font-bold hover:underline mt-2 inline-block">Lihat Katalog &rarr;</a>
                </div>`;
                return;
            }

            list.innerHTML = myOrders.map(o => {
                // Logic Status (PB-13: Notifikasi Status Logistik)
                let statusBadge = "";
                let statusClass = "";
                
                if(o.status === 'pending_verification' || o.status === 'PAID_VERIFY') {
                    statusBadge = "‚è≥ Menunggu Verifikasi Admin";
                    statusClass = "bg-yellow-100 text-yellow-800 border-yellow-200";
                } else if (o.status === 'active' || o.status === 'READY') {
                    statusBadge = "‚úÖ Disetujui / Unit Dikirim";
                    statusClass = "bg-green-100 text-green-800 border-green-200";
                } else if (o.status === 'rejected') {
                    statusBadge = "‚ùå Ditolak (Dokumen Invalid)";
                    statusClass = "bg-red-100 text-red-800 border-red-200";
                } else {
                    statusBadge = o.status;
                    statusClass = "bg-gray-100 text-gray-600";
                }

                // PERBAIKAN SINTAKS DARI SINI: Template literal ditutup dengan benar.
                return `
                <div class="border border-gray-200 rounded-xl p-5 flex flex-col md:flex-row justify-between gap-4 bg-white hover:shadow-sm transition dark:bg-neutral-800 dark:border-neutral-700 group">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                           <span class="text-2xl">üöú</span> 
                           <div>
                              <h4 class="font-bold text-lg text-gray-800 dark:text-white">${o.item_name || 'Alat Berat'}</h4>
                              <p class="text-xs text-gray-400 font-mono">Order ID: ${o.order_id}</p>
                           </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-2 text-sm text-gray-600 dark:text-gray-400 mt-3">
                           <p>üìÖ Mulai: <b>${o.start_date ? o.start_date.split('T')[0] : '-'}</b> (${o.duration})</p>
                           <p>üìç Lokasi: ${o.project_loc}</p>
                        </div>

                        <div class="mt-3">
                           <span class="px-3 py-1 rounded-full text-xs font-bold border ${statusClass} inline-flex items-center gap-1">
                              ${statusBadge}
                           </span>
                        </div>
                    </div>
                </div>`; // <-- Penutup template literal dan div yang benar
            }).join(''); // <-- PENTING: Menutup map dan menggabungkan hasilnya
        } catch (error) {
            console.error('Gagal memuat pesanan:', error);
            list.innerHTML = '<p class="text-center text-red-500 py-10">‚ùå Gagal memuat data. Cek koneksi server atau database.</p>';
        } 
    } // <-- Penutup fungsi loadMyOrders()

    // 3. LOGOUT
    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.clear();
        window.location.href = '/';
    });
</script>