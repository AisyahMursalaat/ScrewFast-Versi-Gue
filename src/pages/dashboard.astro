---
import MainLayout from "@/layouts/MainLayout.astro";
---

<MainLayout title="Pesanan Saya | RentHeavyPro">
    <div class="mx-auto max-w-[85rem] px-4 py-10 sm:px-6 lg:px-8">
        
        <div class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-200 dark:border-neutral-700 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Akun Saya</h1>
                <p class="text-gray-500 text-sm mt-1">Halo, <span id="userNameDisplay" class="font-bold text-orange-600">...</span></p>
            </div>
            <div class="flex gap-3">
                <a href="/products" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-800 transition">‚ûï Sewa Lagi</a>
                <button id="logoutBtn" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-200 transition">Logout</button>
            </div>
        </div>

        <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden dark:bg-neutral-900 dark:border-neutral-700">
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 dark:bg-neutral-800 dark:border-neutral-700 flex justify-between items-center">
                <h3 class="font-bold text-gray-700 dark:text-gray-200">üìã Riwayat Pesanan Saya</h3>
                <button onclick="loadMyOrders()" 
                class="text-xs text-blue-600 hover:underline flex items-center gap-1">üîÑ Refresh Status</button>
            </div>
            
            <div id="myOrderList" class="p-6 space-y-4 min-h-[200px]">
                <p class="text-center text-gray-500 py-10 animate-pulse">Sedang memuat data dari database...</p>
            </div>
        </div>

    </div>

    <div id="extendModal" class="fixed inset-0 z-[999] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-neutral-900 w-full max-w-md rounded-2xl shadow-2xl">
            <div class="p-5 border-b border-gray-200 dark:border-neutral-700 flex justify-between items-center bg-gray-900 rounded-t-2xl">
                <h3 class="font-bold text-xl text-white">üîÑ Perpanjang Sewa</h3>
                <button onclick="closeExtendModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>

            <div class="p-6 space-y-4">
                <div class="bg-gray-50 p-3 rounded-lg border">
                    <p class="text-xs text-gray-500">Order ID</p>
                    <p id="extOrderId" class="font-bold text-gray-800">#TRX-123</p>
                </div>

                <div class="bg-gray-50 p-3 rounded-lg border">
                    <p class="text-xs text-gray-500">Nama Alat</p>
                    <p id="extItemName" class="font-bold text-gray-800">-</p>
                </div>

                <div class="bg-gray-50 p-3 rounded-lg border">
                    <p class="text-xs text-gray-500">Durasi Saat Ini</p>
                    <p id="extCurrentDuration" class="font-bold text-gray-800">-</p>
                </div>
                
                <div class="bg-orange-50 p-3 rounded-lg border border-orange-200">
                    <p class="text-xs text-orange-700">Harga Dasar Harian:</p>
                    <p id="extDailyPriceDisplay" class="font-bold text-orange-800">Rp 0</p>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Tambah Durasi</label>
                    <div class="flex gap-2">
                        <input id="extAddDuration" type="number" value="1" min="1" class="w-20 border p-2.5 rounded text-center">
                        <select id="extDurationType" class="flex-1 border p-2.5 rounded bg-gray-50 font-bold">
                            <option value="Hari">Hari</option>
                            <option value="Bulan">Bulan (Disc 10%)</option>
                            <option value="Tahun">Tahun (Disc 30%)</option>
                        </select>
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-gray-600">Biaya Perpanjangan:</span>
                        <span id="extFeeDisplay" class="font-bold text-blue-700">Rp 0</span>
                    </div>
                    <div id="extDiscountInfo" class="hidden text-xs text-green-600 font-bold">Hemat: Rp 0</div>
                </div>

                <button onclick="submitExtension()" id="btnSubmitExtend" class="w-full bg-gray-900 text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition shadow-md" disabled>
                    Konfirmasi Perpanjangan
                </button>
            </div>
        </div>
    </div>

    <div id="invoiceModal" class="fixed inset-0 z-[999] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white dark:bg-neutral-900 w-full max-w-2xl rounded-2xl shadow-2xl my-8">
            <div class="p-5 border-b border-gray-200 dark:border-neutral-700 flex justify-between items-center bg-gray-900 rounded-t-2xl">
                <h3 class="font-bold text-xl text-white">üìÑ Invoice Pesanan</h3>
                <button onclick="closeInvoiceModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>

            <div id="invoiceContent" class="p-8 space-y-6">
                </div>

            <div class="p-5 border-t bg-gray-50 flex gap-3">
                <button onclick="closeInvoiceModal()" class="flex-1 bg-gray-200 text-gray-800 font-bold py-2.5 rounded-lg hover:bg-gray-300 transition">
                    Tutup
                </button>
                <button onclick="downloadInvoice()" class="flex-1 bg-gray-900 text-white font-bold py-2.5 rounded-lg hover:bg-gray-800 transition shadow-md">
                    üì• Download PDF
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        const API_URL = 'http://localhost:5000/api';
        const UPLOAD_URL = 'http://localhost:5000/uploads';
        
        const userId = localStorage.getItem('userId');
        const userName = localStorage.getItem('username');

        if (!userId || localStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = '/login';
        } else {
            document.getElementById('userNameDisplay').innerText = userName || 'Pelanggan';
            loadMyOrders();
        }

        let currentExtendOrder = null;
        let currentInvoiceOrder = null;

        async function loadMyOrders() {
            const list = document.getElementById('myOrderList');
            try {
                const res = await fetch(`${API_URL}/my-orders/${userId}`); 
                
                // Cek status response dari backend
                if (!res.ok) {
                    throw new Error(`Server responded with status ${res.status}`);
                }

                const myOrders = await res.json();

                if (myOrders.length === 0) {
                    list.innerHTML = `
                    <div class="text-center py-10">
                        <p class="text-4xl mb-2">üì≠</p>
                        <p class="text-gray-500">Belum ada riwayat sewa.</p>
                        <a href="/products" class="text-orange-600 font-bold hover:underline mt-2 inline-block">Lihat Katalog &rarr;</a>
                    </div>`;
                    return;
                }

                list.innerHTML = myOrders.map(o => {
                    let statusBadge = "";
                    let statusClass = "";
                    
                    if(o.status === 'pending_verification' || o.status === 'PAID_VERIFY') {
                        statusBadge = "‚è≥ Menunggu Verifikasi Admin";
                        statusClass = "bg-yellow-100 text-yellow-800 border-yellow-200";
                    } else if (o.status === 'active' || o.status === 'READY') {
                        statusBadge = "‚úÖ Disetujui / Unit Dikirim";
                        statusClass = "bg-green-100 text-green-800 border-green-200";
                    } else if (o.status === 'EXTENDED') {
                        statusBadge = "üîÑ Perpanjangan - Menunggu Verifikasi";
                        statusClass = "bg-blue-100 text-blue-800 border-blue-200";
                    } else if (o.status === 'rejected') {
                        statusBadge = "‚ùå Ditolak (Dokumen Invalid)";
                        statusClass = "bg-red-100 text-red-800 border-red-200";
                    } else {
                        statusBadge = o.status;
                        statusClass = "bg-gray-100 text-gray-600";
                    }

                    // Mengambil item_price yang di-JOIN dari tabel products
                    // Jika o.item_price null/undefined dari JOIN, ini akan menjadi 0
                    const itemDailyPrice = parseFloat(o.item_price) || 0;
                    
                    const canExtend = (o.status === 'active' || o.status === 'READY');

                    return `
                    <div class="border border-gray-200 rounded-xl p-5 bg-white hover:shadow-md transition dark:bg-neutral-800 dark:border-neutral-700">
                        <div class="flex flex-col md:flex-row justify-between gap-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-3">
                                    <span class="text-3xl">${o.item_image && o.item_image.length < 5 ? o.item_image : 'üöú'}</span> 
                                    <div>
                                        <h4 class="font-bold text-lg text-gray-800 dark:text-white">${o.item_name || 'Alat Berat'}</h4>
                                        <p class="text-xs text-gray-400 font-mono">Order ID: ${o.order_id}</p>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 text-sm text-gray-600 dark:text-gray-400">
                                    <p>üìÖ Mulai: <b>${o.start_date ? o.start_date.split('T')[0] : '-'}</b></p>
                                    <p>‚è±Ô∏è Durasi: <b>${o.duration}</b></p>
                                    <p>üìç Lokasi: <b>${o.project_loc}</b></p>
                                    <p>üí∞ Total: <b class="text-orange-600">Rp ${parseInt(o.total_rental_fee).toLocaleString()}</b></p>
                                </div>

                                <div class="mt-3">
                                    <span class="px-3 py-1 rounded-full text-xs font-bold border ${statusClass} inline-flex items-center gap-1">
                                        ${statusBadge}
                                    </span>
                                </div>
                            </div>

                            <div class="flex flex-col gap-2 md:w-40">
                                <button onclick="viewInvoice('${o.order_id}')" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-800 transition">
                                    üìÑ Invoice
                                </button>
                                ${canExtend ? `
                                <button onclick="openExtendModal('${o.order_id}', '${o.item_name}', '${o.duration}', ${itemDailyPrice})" 
                                        class="bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-orange-700 transition shadow-md">
                                    üîÑ Perpanjang
                                </button>` : ''}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } catch (error) {
                console.error('Gagal memuat pesanan:', error);
                // Menampilkan pesan error yang generic
                list.innerHTML = '<p class="text-center text-red-500 py-10">‚ùå Gagal memuat data. Cek koneksi server atau database.</p>';
            } 
        }

        // === PERPANJANGAN SEWA ===
        window.openExtendModal = (orderId, itemName, currentDuration, dailyPrice) => {
            const price = parseInt(dailyPrice) || 0; 
            const btnSubmit = document.getElementById('btnSubmitExtend');


            currentExtendOrder = { 
                orderId: orderId, 
                itemName: itemName, 
                currentDuration: currentDuration, 
                dailyPrice: price, 
                extensionFee: 0 
            };
            
            document.getElementById('extOrderId').innerText = orderId;
            document.getElementById('extItemName').innerText = itemName;
            document.getElementById('extCurrentDuration').innerText = currentDuration;
            document.getElementById('extDailyPriceDisplay').innerText = `Rp ${price.toLocaleString('id-ID')}`; 
            
            // Mengatur status awal tombol
            if (price === 0) {
                btnSubmit.disabled = true;
                btnSubmit.innerText = 'Harga Dasar Nol (Hubungi Admin)';
            } else {
                btnSubmit.disabled = false;
                btnSubmit.innerText = 'Konfirmasi Perpanjangan';
            }
            
            document.getElementById('extAddDuration').value = 1;
            document.getElementById('extDurationType').value = 'Hari';
            
            calculateExtensionFee();
            document.getElementById('extendModal').classList.remove('hidden');
        };

        window.closeExtendModal = () => {
            document.getElementById('extendModal').classList.add('hidden');
            currentExtendOrder = null;
        };

        function calculateExtensionFee() {
            if (!currentExtendOrder) return;
            
            const dailyPrice = currentExtendOrder.dailyPrice;
            const durationInput = document.getElementById('extAddDuration').value;
            const duration = parseInt(durationInput) || 1; 
            const type = document.getElementById('extDurationType').value;
            const discountInfo = document.getElementById('extDiscountInfo');
            const btnSubmit = document.getElementById('btnSubmitExtend');
            
            let fee = 0;
            let normalFee = 0;
            
            // --- Logika Perhitungan Harga ---
            if (dailyPrice === 0) {
                fee = 0;
            } else if (type === 'Hari') {
                fee = dailyPrice * duration;
                discountInfo.classList.add('hidden');
            } else if (type === 'Bulan') {
                normalFee = dailyPrice * 30 * duration;
                fee = normalFee * 0.9;
                const hemat = Math.round(normalFee - fee);
                discountInfo.innerText = `Hemat: Rp ${hemat.toLocaleString('id-ID')} (Disc 10%)`;
                discountInfo.classList.remove('hidden');
            } else if (type === 'Tahun') {
                normalFee = dailyPrice * 365 * duration;
                fee = normalFee * 0.7;
                const hemat = Math.round(normalFee - fee);
                discountInfo.innerText = `Hemat: Rp ${hemat.toLocaleString('id-ID')} (Disc 30%)`;
                discountInfo.classList.remove('hidden');
            }
            
            const finalFee = Math.round(fee);
            
            document.getElementById('extFeeDisplay').innerText = `Rp ${finalFee.toLocaleString('id-ID')}`;
            currentExtendOrder.extensionFee = finalFee; 

            // --- Logika Aktivasi Tombol (Validasi Biaya) ---
            if (dailyPrice === 0) {
                btnSubmit.disabled = true;
                btnSubmit.innerText = 'Harga Dasar Nol (Hubungi Admin)';
            } else if (finalFee <= 0) {
                btnSubmit.disabled = true;
                btnSubmit.innerText = 'Biaya perpanjangan nol';
            } else {
                btnSubmit.disabled = false;
                btnSubmit.innerText = 'Konfirmasi Perpanjangan';
            }
        }

        document.getElementById('extAddDuration').addEventListener('input', calculateExtensionFee);
        document.getElementById('extDurationType').addEventListener('change', calculateExtensionFee);

        window.submitExtension = async () => {
            if (!currentExtendOrder || currentExtendOrder.extensionFee <= 0) {
                alert('‚ùå Biaya perpanjangan belum terhitung atau bernilai nol. Cek kembali durasi sewa.');
                return;
            }
            
            const btn = document.getElementById('btnSubmitExtend');
            btn.disabled = true;
            btn.innerText = 'Memproses...';

            const duration = document.getElementById('extAddDuration').value;
            const type = document.getElementById('extDurationType').value;
            const additionalDuration = `${duration} ${type}`;
            const additionalFee = currentExtendOrder.extensionFee; 

            try {
                // POST ke backend untuk mengajukan perpanjangan
                const res = await fetch(`${API_URL}/extend-rental`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: currentExtendOrder.orderId,
                        additionalDuration: additionalDuration,
                        additionalFee: additionalFee
                    })
                });

                const result = await res.json();
                
                if (result.success) {
                    alert(`‚úÖ Permintaan Perpanjangan Berhasil! Admin akan memproses verifikasi biaya sebesar Rp ${additionalFee.toLocaleString('id-ID')}.`);
                    closeExtendModal();
                    loadMyOrders();
                } else {
                    alert(`‚ùå Gagal: ${result.message}`);
                    if(result.error) {
                        console.error('Server Error:', result.error);
                    }
                }
            } catch (error) {
                console.error('Koneksi Error:', error);
                alert('‚ùå Terjadi kesalahan koneksi ke server.');
            } finally {
                btn.disabled = false;
                btn.innerText = 'Konfirmasi Perpanjangan';
            }
        };

        // === FUNGSI INVOICE & LOGOUT ===
        window.viewInvoice = async (orderId) => {
            try {
                const res = await fetch(`${API_URL}/invoice/${orderId}`);
                const result = await res.json();
                
                if (!result.success) {
                    alert('‚ùå Invoice tidak ditemukan');
                    return;
                }
                
                currentInvoiceOrder = result.data;
                renderInvoice(result.data);
                document.getElementById('invoiceModal').classList.remove('hidden');
            } catch (error) {
                console.error(error);
                alert('‚ùå Gagal memuat invoice');
            }
        };

        window.closeInvoiceModal = () => {
            document.getElementById('invoiceModal').classList.add('hidden');
            currentInvoiceOrder = null;
        };

        function renderInvoice(data) {
            const content = document.getElementById('invoiceContent');
            const invoiceDate = new Date(data.created_at).toLocaleDateString('id-ID', { 
                year: 'numeric', month: 'long', day: 'numeric' 
            });

            content.innerHTML = `
                <div class="text-center border-b pb-6">
                    <h1 class="text-3xl font-bold text-gray-900">INVOICE</h1>
                    <p class="text-gray-500 mt-1">PT RentHeavyPro Indonesia</p>
                    <p class="text-sm text-gray-400">Jl. Industri Berat No. 123, Jakarta</p>
                </div>

                <div class="grid grid-cols-2 gap-6 my-6">
                    <div>
                        <p class="text-xs text-gray-500 font-bold mb-2">INVOICE TO:</p>
                        <p class="font-bold text-gray-900">${data.customer_name}</p>
                        <p class="text-sm text-gray-600">${data.project_loc}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500 font-bold mb-2">INVOICE DETAILS:</p>
                        <p class="text-sm"><span class="font-bold">No:</span> ${data.order_id}</p>
                        <p class="text-sm"><span class="font-bold">Tanggal:</span> ${invoiceDate}</p>
                        <p class="text-sm"><span class="font-bold">Status:</span> 
                            <span class="px-2 py-0.5 rounded text-xs font-bold ${
                                data.status === 'READY' || data.status === 'active' ? 'bg-green-100 text-green-700' : 
                                data.status === 'PAID_VERIFY' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'
                            }">${data.status}</span>
                        </p>
                    </div>
                </div>

                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold">Item</th>
                            <th class="border border-gray-300 px-4 py-3 text-center text-sm font-bold">Durasi</th>
                            <th class="border border-gray-300 px-4 py-3 text-center text-sm font-bold">Mulai</th>
                            <th class="border border-gray-300 px-4 py-3 text-right text-sm font-bold">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border border-gray-300 px-4 py-3">
                                <p class="font-bold text-gray-900">${data.item_name}</p>
                                <p class="text-xs text-gray-500">Sewa Alat Berat - Lepas Kunci</p>
                            </td>
                            <td class="border border-gray-300 px-4 py-3 text-center">${data.duration}</td>
                            <td class="border border-gray-300 px-4 py-3 text-center">${data.start_date.split('T')[0]}</td>
                            <td class="border border-gray-300 px-4 py-3 text-right font-bold">
                                Rp ${parseInt(data.total_rental_fee).toLocaleString()}
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="bg-gray-50">
                            <td colspan="3" class="border border-gray-300 px-4 py-3 text-right font-bold">TOTAL:</td>
                            <td class="border border-gray-300 px-4 py-3 text-right font-bold text-lg text-orange-600">
                                Rp ${parseInt(data.total_rental_fee).toLocaleString()}
                            </td>
                        </tr>
                    </tfoot>
                </table>

                <div class="mt-8 text-center text-xs text-gray-400">
                    <p>Dokumen ini dibuat secara otomatis dan sah tanpa tanda tangan</p>
                </div>
            `;
        }

        window.downloadInvoice = async () => {
            if (!currentInvoiceOrder) return;
            
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = '‚è≥ Generating PDF...';
            btn.disabled = true;

            try {
                const invoiceElement = document.getElementById('invoiceContent');
                
                const canvas = await html2canvas(invoiceElement, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                const imgData = canvas.toDataURL('image/png');
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                
                pdf.save(`Invoice_${currentInvoiceOrder.order_id}.pdf`);
                
                alert('‚úÖ Invoice berhasil didownload!');
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('‚ùå Gagal generate PDF. Mencoba metode print...');
                
                const printWindow = window.open('', '_blank');
                const invoiceHTML = document.getElementById('invoiceContent').innerHTML;
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Invoice ${currentInvoiceOrder.order_id}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                            th { background-color: #f3f4f6; font-weight: bold; }
                            .text-center { text-align: center; }
                            .text-right { text-align: right; }
                            .font-bold { font-weight: bold; }
                            .bg-gray-50 { background-color: #f9fafb; }
                            .bg-blue-50 { background-color: #eff6ff; }
                            .border { border: 1px solid #e5e7eb; }
                            .rounded-lg { border-radius: 8px; }
                            .p-4 { padding: 16px; }
                            .mb-2 { margin-bottom: 8px; }
                            .space-y-1 > * + * { margin-top: 4px; }
                            @media print {
                                body { padding: 0; }
                                button { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        ${invoiceHTML}
                        <div style="margin-top: 30px; text-align: center;">
                            <button onclick="window.print()" style="background: #2563eb; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                üñ®Ô∏è Print / Save as PDF
                            </button>
                        </div>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
            }
            
            btn.innerText = originalText;
            btn.disabled = false;
        };

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.clear();
            window.location.href = '/';
        });
    </script>
</MainLayout>